<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<title>Introduction</title>
<link rel="stylesheet" href="./lab-style.css">
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="paragraph">
<p>Author: Mark Roberts (feedback to <a href="mailto:mroberts@redhat.com">mroberts@redhat.com</a>)</p>
</div>
<div class="sect2">
<h3 id="_introduction">Introduction</h3>
<div class="paragraph">
<p>DevOps is a much overloaded term that is used to describe a variety of concepts in the creation of modern applications. In a simple definition DevOps is concerned with the interface between development practices used for the creative elements of software engineering and the procedural rigour of operationally running applications in production. Clearly these concepts have different objectives so it is important for teams (whether tasked with development or operations) to have a good understanding of the concepts, objectives and concerns of their counterparts on the other side of the fence.</p>
</div>
<div class="paragraph">
<p>In terms of this workshop it is important to highlight the capabilities of containerized platforms with respect to the roll out of new versions of applications and how they get introduced to production and to end users. Terms such as blue/green deployments, black and white deployments, A/B deployments and canary deployments are used in various text books on 'DevOps' principles and some of these areas will be used in this chapter of the workshop.</p>
</div>
<div class="paragraph">
<p>The activities in this workshop will introduce a new version of a simple application to use in two different manners.</p>
</div>
<div class="sect3">
<h4 id="_workshop_content">Workshop Content</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The application to be used in this workshop is a simple NodeJS REST interface. Version 1 exists on the master branch of the GIT Repository and version 2 exists on the experimental branch.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To begin the creation of the application use the following commands in an command line window. :</p>
</div>
</div>
<div class="sect3">
<h4 id="_creation_of_version_1">Creation of version 1</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc new-project simple-rest-{{USER_ID}}

oc new-app --name simple-rest-app-v1-0  https://github.com/marrober/simpleRest.git --as-deployment-config

oc expose service simple-rest-app-v1-0 --name="simple-rest-app-route"</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">What was added to the project ?</div>
<div class="paragraph">
<p>It is important to understand the resources and content that are created by the above commands within OpenShift:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A new project is created called simple-rest-{{USER_ID}}.</p>
</li>
<li>
<p>A deployment configuration is created called simple-rest-app-v1-0.</p>
</li>
<li>
<p>A replication controller is created associated with the application and the built objects. This defines the scaling of the application in terms of the number of pods and the deployment strategy (rolling or recreate).</p>
</li>
<li>
<p>A build configuration is created to compile the application source code which is extracted from the associated GIT repository.</p>
</li>
<li>
<p>The build configuration will create a build instance which includes logs of the build process and a reference to the built image.</p>
</li>
<li>
<p>The newly created image is deployed as a running pod (or pods depending on the number of pods defined in the deployment configuration).</p>
</li>
<li>
<p>A service is created as part of the application creation process. The service endpoints will point to the pod(s) created by the build process. In the case of a rebuild and redeploy operation the service endpoints are updated to point to the new pods in accordance with the deployment strategy of the deployment configuration.</p>
</li>
<li>
<p>The service is then exposed external to the cluster by the creation of a route. The route has a fully qualified domain name for access from machines outside the cluster.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The diagram below shows the above and how they relate together.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="deployment-strategies-1.png" alt="Deployment artefacts">
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To identify the URL of the route execute the command shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get route simple-rest-app-route -o jsonpath='{"http://"}{.spec.host}{"/ip\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will display a formatted URL with the 'http://' part at the beginning which will be similar to :</p>
</div>
<div class="paragraph">
<p>http://simple-rest-app-route-simple-rest.apps.cluster-xxxx-yyyy.xxxx-yyyy.example.opentlc.com/ip</p>
</div>
<div class="paragraph">
<p>Before testing the application you need to be sure that it is running. Type the command shown below which will show the status for the build, deploy and application pods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>Repeat the above command periodically until the deploy and build pods have a status of completed and you have a running application pod as shown in the example below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="deployment-strategies-1a.png" alt="Deployment artefacts">
</div>
</div>
<div class="paragraph">
<p>To test the application use the command line window to issue a curl command to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>curl &lt;url from the above command&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The response should be as shown below (example ip address) :</p>
</div>
<div class="paragraph">
<p>"10.131.0.114 v1.0"</p>
</div>
</div>
<div class="sect3">
<h4 id="_creation_of_version_2">Creation of version 2</h4>
<div class="paragraph">
<p>The development team now wants to introduce an experimental version 2 of the application and introduce it to the users in a number of different ways. The first action is to create the new build process for the experimental version using the command below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc new-app --name simple-rest-app-v2-0 https://github.com/marrober/simpleRest.git#experimental --as-deployment-config</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Note the use of the #experimental branch identifier in the end of the GIT repository. To use this additional capability through the web user interface select "Advanced Git Options" after pasting the URL. You may then enter a branch, tag or commit ID to refine the content that is used. It is also possible to configure the source-2-image capability to reference a specific sub directory of the repository using the --context option.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">What was added to the project ?</div>
<div class="paragraph">
<p>New content was added to the project as a result of the above command specific to the experimental (v2) version of the application.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A deployment configuration</p>
</li>
<li>
<p>A replication controller</p>
</li>
<li>
<p>A build configuration</p>
</li>
<li>
<p>A running container in a pod</p>
</li>
<li>
<p>A service</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The diagram below shows the above and how they relate together.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="deployment-strategies-2.png" alt="Deployment artefacts">
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>At this point the version 2 application is operational but not accessible externally to the cluster.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_blue_green_deployment">Blue / Green Deployment</h3>
<div class="paragraph">
<p>The benefit of creating the new version of the application alongside the old is that it is quick and easy to migrate users to a new version of the application. It also allows teams to validate that the pods are running correctly.</p>
</div>
<div class="paragraph">
<p>Switching the route from v1 to v2 involves patching the route to change configuration. Before executing this operation open a new command window (use the duplicate function on the browser if you are using a command line running in a container) and execute the command below to send requests to the route every second. The responses received should all include the ip address of the pod and the version (v1) of the application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>for i in {1..1000}; do curl $(oc get route simple-rest-app-route -o jsonpath='{"http://"}{.spec.host}{"/ip"}') ; echo ""; sleep 1; done</code></pre>
</div>
</div>
<div class="paragraph">
<p>A series of reports of ip address and version 1 of the application will then start to scroll up the screen. Leave this running.</p>
</div>
<div class="paragraph">
<p>Switch back to the original command window and execute the command below to patch the route to version 2 of the application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc patch route/simple-rest-app-route -p '{"spec":{"to":{"name":"simple-rest-app-v2-0"}}}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Switch back to the command window with the shell script running and you should see the responses have a new ip address and now report v2 of the application. This has completed a migration from the old version of the application to the new.</p>
</div>
<div class="paragraph">
<p>The details of the route patched by the above command are displayed by the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get route/simple-rest-app-route -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of the above command is shown below, and the nested information from spec &#8594; to &#8594; name is easy to see.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>apiVersion: route.openshift.io/v1
kind: Route
metadata:
  annotations:
    openshift.io/host.generated: "true"
  creationTimestamp: 2019-12-04T17:16:37Z
  labels:
    app: simple-rest-app-v1-0
  name: simple-rest-app-route
  namespace: simple-rest-{{USER_ID}}
  resourceVersion: "884652"
  selfLink: /apis/route.openshift.io/v1/namespaces/simple-rest/routes/simple-rest-app-route
  uid: d4910fef-16b9-11ea-a6c5-0a580a800048
spec:
  host: simple-rest-app-route-simple-rest.apps.cluster-telf-c8e6.telf-c8e6.example.opentlc.com
  port:
    targetPort: 8080-tcp
  subdomain: ""
  to:
    kind: Service
    name: simple-rest-app-v2-0
    weight: 100
  wildcardPolicy: None
status:
  ingress:
  - conditions:
    - lastTransitionTime: 2019-12-04T17:16:38Z
      status: "True"
      type: Admitted
    host: simple-rest-app-route-simple-rest.apps.cluster-telf-c8e6.telf-c8e6.example.opentlc.com
    routerCanonicalHostname: apps.cluster-telf-c8e6.telf-c8e6.example.opentlc.com
    routerName: default
    wildcardPolicy: None</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before moving to the A/B deployment strategy switch back to version v1 with the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc patch route/simple-rest-app-route -p '{"spec":{"to":{"name":"simple-rest-app-v1-0"}}}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Confirm this has worked in the command window executing the shell script. If the shell script has ended you may need to re-run it to send requests to the application again.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ab_deployment">A/B Deployment</h3>
<div class="paragraph">
<p>The benefit of an A/B deployment strategy is that it is possible to gradually migrate workload to the new version. This example presents a simple process of gradually migrating a higher and higher percentage of traffic to the new version, however more advanced options are available for migrating traffic based on headers or source ip address to name just two. Red Hat OpenShift Service Mesh is another topic that is worth investigation if advanced traffic routing operations are of interest.</p>
</div>
<div class="paragraph">
<p>Ensure that the shell script shown above is running to send requests to the application.</p>
</div>
<div class="paragraph">
<p>Gradually migrating traffic from v1 to v2 involves patching the route to change configuration as shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="deployment-strategies-3.png" alt="Traffic routing">
</div>
</div>
<div class="paragraph">
<p>To migrate 30% of traffic to version 2 execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc set route-backends simple-rest-app-route simple-rest-app-v1-0=70 simple-rest-app-v2-0=30</code></pre>
</div>
</div>
<div class="paragraph">
<p>Switch back to the command window running the shell script and after a short wait you will see the occasional report from version 2.</p>
</div>
<div class="paragraph">
<p>To balance the workload between the two versions execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc set route-backends simple-rest-app-route simple-rest-app-v1-0=50 simple-rest-app-v2-0=50</code></pre>
</div>
</div>
<div class="paragraph">
<p>Switch back to the command window running the shell script and after a short wait you will see a more even distribution of calls between versions 1 and 2.</p>
</div>
<div class="paragraph">
<p>The details of the route patched by the above command are displayed by the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get route/simple-rest-app-route -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>A section of the output of the above command is included below, showing the split of traffic between versions 1 and 2.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>spec:
  alternateBackends:
  - kind: Service
    name: simple-rest-app-v2-0
    weight: 50
  host: simple-rest-app-route-simple-rest.apps.cluster-telf-c8e6.telf-c8e6.example.opentlc.com
  port:
    targetPort: 8080-tcp
  subdomain: ""
  to:
    kind: Service
    name: simple-rest-app-v1-0
    weight: 50</code></pre>
</div>
</div>
<div class="paragraph">
<p>When satisfied that version 2 is working as required the following command will switch all traffic to that version.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc set route-backends simple-rest-app-route simple-rest-app-v1-0=0 simple-rest-app-v2-0=100</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_url_based_routing">URL based routing</h3>
<div class="paragraph">
<p>Many organizations want to use a common URL for their web sites so that it is easy for users. This is often achieved by pointing a specific URL at an OpenShift cluster route within a global load balancer function, however this is not essential and it is possible to use routes to achieve the same result. Take as an example a holiday company called myholiday.com. The company wishes to sell package holidays, short breaks, cruises and adventure holidays and they create different applications for these purposes. By using a common host name in a series of route it is possible to ensure that traffic flows to the right location based on the path of the url used. The diagram below shows the described scenario and how the routes, services and applications work together</p>
</div>
<div class="imageblock">
<div class="content">
<img src="deployment-strategies-4.png" alt="URL based routing">
</div>
</div>
<div class="paragraph">
<p>In this example you will create an application that mirrors that shown above and you will use a single URL for access to the four different elements of the application.</p>
</div>
<div class="sect3">
<h4 id="_creating_the_applications">Creating the applications</h4>
<div class="paragraph">
<p>This example uses a common code base to create the specific applications for the above four holiday types. To create the four applications in a single project use the steps below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc new-project myholiday-{{USER_ID}}
oc new-app https://github.com/utherp0/workshop4.git --context-dir=attendee/myholiday \
--name=short-holiday -l app.kubernetes.io/part-of=holidays HOLIDAY_TYPE=short-break --as-deployment-config
oc new-app https://github.com/utherp0/workshop4.git --context-dir=attendee/myholiday \
--name=package-holiday -l app.kubernetes.io/part-of=holidays HOLIDAY_TYPE=package --as-deployment-config
oc new-app https://github.com/utherp0/workshop4.git --context-dir=attendee/myholiday \
--name=cruise-holiday -l app.kubernetes.io/part-of=holidays HOLIDAY_TYPE=cruise --as-deployment-config
oc new-app https://github.com/utherp0/workshop4.git --context-dir=attendee/myholiday \
--name=adventure-holiday -l app.kubernetes.io/part-of=holidays HOLIDAY_TYPE=adventure --as-deployment-config</code></pre>
</div>
</div>
<div class="paragraph">
<p>Switch to the web user interface and select the project that you have just created. Then select the topology view from the left hand side developer menu and watch the applications build and deploy. Progress of the build phase can also be tracked using the command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get build</code></pre>
</div>
</div>
<div class="paragraph">
<p>When all of the builds are complete the applications will take a few seconds to deploy and then will be ready.</p>
</div>
<div class="paragraph">
<p>At this stage the applications have services but they do not have any routes exposing them outside the cluster. Ordinarily users would create a route for each application which would result in a different URL for each. In this activity a common URL is required for all four.</p>
</div>
<div class="paragraph">
<p>To identify the cluster specific element of the hostname to use for the route, create a temporary route using the command below. The second command is used to get the hostname for the route.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code> oc expose service/adventure-holiday
 oc get route adventure-holiday -o jsonpath='{.spec.host}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will result in a new route being created and the hostname will be displayed similar to :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>adventure-holiday-myholiday_user2.apps.cluster-c2d5.c2d5.example.opentlc.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>(Note your user number may differ).</p>
</div>
<div class="paragraph">
<p>The element of the path that we need for the new common hostname is from the .apps part forward, and a new part will be created to replace 'adventure-holiday-myholiday_user2' based on the project name. A shell script is used to configure the four route creation yaml files which are stored in the workshop git repository. Switch directory and examine one of the yaml files.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd workshop4/attendee/myholiday
cat adventure-route.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The YAML file is shown below :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>apiVersion: route.openshift.io/v1
kind: Route
metadata:
  labels:
    app: adventure-holiday
  name: adventure-route
spec:
  host: URL
  path: "/adventure"
  to:
    kind: Service
    name: adventure-holiday
    weight: 100</code></pre>
</div>
</div>
<div class="paragraph">
<p>The host 'URL' will be replaced by the configure-routes.sh shell script. The path shows /adventure, and a similar path exists in the cruise, package and short-break files to point to their specific paths.</p>
</div>
<div class="paragraph">
<p>Execute the shell script 'configure-routes.sh' with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>./configure-routes.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now take another look at adventure-route.yaml, which will be similar to that which is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>apiVersion: route.openshift.io/v1
kind: Route
metadata:
  labels:
    app: adventure-holiday
  name: adventure-route
spec:
  host: myholiday_user2.apps.cluster-c2d5.c2d5.example.opentlc.com
  path: "/adventure"
  to:
    kind: Service
    name: adventure-holiday
    weight: 100</code></pre>
</div>
</div>
<div class="paragraph">
<p>The host path is now made up of the common element from the project name and the common cluster specific path.</p>
</div>
<div class="paragraph">
<p>Delete the temporary route used to generate the hostname with the command below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc delete route/adventure-holiday</code></pre>
</div>
</div>
<div class="paragraph">
<p>Execute the following commands to create the four routes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f adventure-route.yaml
oc create -f cruise-route.yaml
oc create -f package-route.yaml
oc create -f short-break-route.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Examine the new routes using the command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get routes</code></pre>
</div>
</div>
<div class="paragraph">
<p>An example of the important information from the above command is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME                  HOST/PORT                                               PATH           SERVICES
adventure-route       myholiday_user2.apps.cluster-c2d5.c2d5.example.opentlc.com   /adventure     adventure-holiday
cruise-route          myholiday_user2.apps.cluster-c2d5.c2d5.example.opentlc.com   /cruise        cruise-holiday
package-route         myholiday_user2.apps.cluster-c2d5.c2d5.example.opentlc.com   /package       package-holiday
short-holiday-route   myholiday_user2.apps.cluster-c2d5.c2d5.example.opentlc.com   /short-break   short-holiday</code></pre>
</div>
</div>
<div class="paragraph">
<p>Test the routes (copy and paste from your result of the 'oc get routes' command - do not copy the commands below &#8230;&#8203;. ) by accessing the four different holiday types from the common url with the curl commands below. The text responses will show that the correct application is responding to each request.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>curl &lt;common-url&gt;/adventure
curl &lt;common-url&gt;/cruise
curl &lt;common-url&gt;/package
curl &lt;common-url&gt;/short-break</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cleaning_up">Cleaning up</h4>
<div class="paragraph">
<p>From the OpenShift browser window click on 'Administrator' and then 'Projects' on the left hand side menu.</p>
</div>
<div class="paragraph">
<p>In the triple dot menu next to your own project (simple-rest-{{USER_ID}}) select ‘Delete Project’
Type ‘simple-rest-{{USER_ID}}’ such that the Delete button turns red and is active.
Press Delete to remove the project.</p>
</div>
<div class="paragraph">
<p>Repeat the above process for the myholiday-{{USER_ID}} project too.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-04-06 19:08:41 UTC
</div>
</div>
</body>
</html>