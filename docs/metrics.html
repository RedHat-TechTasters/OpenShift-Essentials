<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<title>Introduction</title>
<link rel="stylesheet" href="./lab-style.css">
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="paragraph">
<p>Author: Ian Lawson (feedback to <a href="mailto:ian.lawson@redhat.com">ian.lawson@redhat.com</a>)</p>
</div>
<div class="sect2">
<h3 id="_introduction">Introduction</h3>
<div class="paragraph">
<p>This lab intends to introduce the developer to the tools available within OpenShift for logging and debugging applications.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">The OpenShift Approach to Logging and Metrics</div>
<div class="paragraph">
<p>OpenShift actually provides three distinct levels of information when it comes to logging:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Events</strong></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Events are changes to the object model within OpenShift. They relate to the objects stored as part of the state of the applications, i.e. the Pods, the Services, the Routes etc. Events are short-lived; they expire after an hour. They provide a very good indication of issues when the problem is to do with the orchestration of the application in the platform itself.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Metrics</strong></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Metrics are the behavioural characteristics of the Containers/Pods themselves. Not the application, but how much CPU, Memory, networking etc the Pods (that contain the application) are consuming. This provides a very good indication of how the orchestrated Pods are behaving, but not the applications within.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Logging</strong></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Finally the lowest level information. This is the log output from the actual application running in the Container. The nature of logging is slightly different in a Container orchestration system because you can have <strong>many</strong> applications running with the same name. OpenShift provides a clever mechanism for logging that identifies the application by a set of metadata that relates to the application&#8217;s existence in the orchestration system as well the application&#8217;s identity. This means that OpenShift can store the output of many identical applications but the applications can be examined independently.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>This lab will walk you through some examples of using the various mechanisms to observe and fix some problems developers will encounter while developing on OpenShift.</p>
</div>
</div>
<div class="sect2">
<h3 id="_events">Events</h3>
<div class="paragraph">
<p>As previously stated Events are changes to the object model within OpenShift. In this part of the lab we are going to trigger some events by breaking an application.</p>
</div>
<div class="paragraph">
<p>The first step is to setup the workspace in which we will be working. In the UI (using the URL provided in the prerequisites) logon to your account, if you haven&#8217;t already. Then go to the Administrator view (by going to the top left of the menu and selecting Adminstrator).</p>
</div>
<div class="paragraph">
<p>On the Adminstrator view choose Home/Projects.</p>
</div>
<div class="paragraph">
<p>Click on 'Create Project'. Set the name to events-{{USER_ID}}. Set the Display Name to 'Events Test Project'. Hit create.</p>
</div>
<div class="paragraph">
<p>Once the Project has created you should be taken to the Project Details tab. Select Home/Events in the left hand menu. The resulting screen should look similar to this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="events1.png" alt="Events tab empty">
</div>
</div>
<div class="paragraph">
<p>Now we will add an application to the project. Switch to the Developer view by clicking on Administrator and selecting Developer.</p>
</div>
<div class="paragraph">
<p>Click on +Add. Choose 'From Catalog'. Enter <strong>node</strong> in the search box. Click on the 'node.js' Builder Image</p>
</div>
<div class="paragraph">
<p>Click 'Create Application'. In the 'Git Repo URL' textbox enter <a href="https://github.com/utherp0/workshop4" class="bare">https://github.com/utherp0/workshop4</a></p>
</div>
<div class="paragraph">
<p>Insure the text 'Validated' appears beneath the textbox. If it doesn&#8217;t check the URL</p>
</div>
<div class="paragraph">
<p>Click on 'Show Advanced Git Options'</p>
</div>
<div class="paragraph">
<p>In the Context Dir textbox enter /apps/nodeatomic</p>
</div>
<div class="paragraph">
<p>Scroll down to the <strong>General</strong> section. Set the 'Application Name' to 'events-app'.</p>
</div>
<div class="paragraph">
<p>Set the 'Name' to 'nodeatomic'</p>
</div>
<div class="paragraph">
<p>Scroll down to the <strong>Resources</strong> section. Select 'DeploymentConfig'.</p>
</div>
<div class="paragraph">
<p>Click Create. Leave the application building and switch back to Adminstrator viewpoint (by clicking on Developer at the top left and choosing Administrator).</p>
</div>
<div class="paragraph">
<p>Click on Home/Events. You will see a screen similar to this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="events3.png" alt="build happening">
</div>
</div>
<div class="paragraph">
<p>Click on the pause icon at the top of the Events list.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Events only exist on the system for an hour. You can pause the flow of events to read them by clicking on the pause icon.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that the events show the build container being pulled, created, deployed and executed.</p>
</div>
<div class="paragraph">
<p>Now in the dropdown menu at the top left (above the events) set the resource to 'Build' (build.openshift.io/v1). This will filter the events to only ones from that type of resource. The screen should now look like:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="events4.png" alt="build events only">
</div>
</div>
<div class="paragraph">
<p>Now in the dropdown menu at the top left (above the events) set the resource to 'Pod'. Remove the 'Build' filter.</p>
</div>
<div class="paragraph">
<p>Pause the event stream again. It should look like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="events4b.png" alt="pod events paused">
</div>
</div>
<div class="paragraph">
<p>Switch to your terminal app window (the command line interface described in the prerequisites). type the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc project events-{{USER_ID}}
oc get dc
oc scale dc/nodeatomic --replicas=6</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="events5.png" alt="manually scale">
</div>
</div>
<div class="paragraph">
<p>Switch back to the OpenShift UI. You should still be on the Events tab with the events stream paused. Hit the play icon at the top left of the event stream list. You will notice new events relating to the creation of the new Pods.</p>
</div>
<div class="paragraph">
<p>The events are short lived and related entirely to the behaviour of the objects within your project, and any project you can see through the RBAC policies applied for you.</p>
</div>
</div>
<div class="sect2">
<h3 id="_metrics">Metrics</h3>
<div class="paragraph">
<p>Metrics are the behavioural statistics for the Containers; each container in the system, within a Pod, generates a consistent stream of metrics that can be viewed and processed by the control plane.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">OpenShift Container Metrics</div>
<div class="paragraph">
<p>Each Pod outputs three streams of realtime metrics. These are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Memory Usage</strong></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The current memory consumption for the Pod in question. This can be limited by administrators on a Project basis. This is expressed in MiB by default.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>CPU Usage</strong></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The current CPU consumption for the Pod in question. This can be limited by asministrators on a Project basis. This is expressed in millicores by default.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Filesystem</strong></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The current file access consumption. This is expressed in KiB by default.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>In the Administration view click on Workloads/Pods.</p>
</div>
<div class="paragraph">
<p>Set the filter at the top left of the page to 'Running'</p>
</div>
<div class="paragraph">
<p>Select the topmost Pod and click on its name. The Pod Details tab will display the current metrics for the Pod.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="events6.png" alt="Example Pod metrics">
</div>
</div>
<div class="paragraph">
<p>Now click on Home/Projects. Click on the events-{{USER_ID}} project. Scroll down to the 'Utilization' section. This shows graphs for the agregated metrics for <strong>all</strong> Pods running in the Project, along with network transfer in/out for the Project and Pod count.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="events7.png" alt="Aggregated Pod metrics">
</div>
</div>
<div class="paragraph">
<p>On the Utilization tab click directly on the Pod Count graph itself. This will take you to an expanded graph which is a realtime version of the metrics executed by a query. The query is displayed beneath the graph. If you watch the graph it will update periodically.</p>
</div>
<div class="paragraph">
<p>Switch back to the terminal tab and enter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc scale dc/nodeatomic --replicas=1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Switch back to OpenShift UI. After a small pause (the metrics are collected over time) the graph should drop to reflect the change in Pod count.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="events8.png" alt="pods scaled back">
</div>
</div>
<div class="paragraph">
<p>This Metric functionality is incrdibly powerful and is being further developed for later releases.</p>
</div>
</div>
<div class="sect2">
<h3 id="_logging">Logging</h3>
<div class="paragraph">
<p>Logging is the output of the actual applications themselves. By default OpenShift logs all output of the Application.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Handling Application Multiplicity in Logging</div>
<div class="paragraph">
<p>One of the major hurdles when crafting logging for a Container orchestration system is the non-uniqueness of the Application across the estate.</p>
</div>
<div class="paragraph">
<p>Put simply, you can have one or more copies of the same Application running. In previous systems, such as virtualisation, each application was unique on the hosting mechanism. With Container orchestration this isn&#8217;t the case.</p>
</div>
<div class="paragraph">
<p>There was a stack called ELK - ElasticSearch, Logstash and Kibana. ElasticSearch provided the search mechanism which comprised of individual searchable 'documents' which encompassed each log. These were keyed by the Application name. Logstash would take the log from the Application, create the searchable component that was uniquely keyed by the Application name. and then users would apply searches using Kibana.</p>
</div>
<div class="paragraph">
<p>In a Container orchestration system this wouldn&#8217;t work as your <strong>multiple</strong> copies of the Application would generate records with the same Application name - imagine you had three copies of Application 'myapp' running and one was generating errors. You wouldn&#8217;t be able to identify which one because all the logs would be indexed using 'myapp'.</p>
</div>
<div class="paragraph">
<p>So for OpenShift a new stack was used - the EFK stack. This consists, again, of ElasticSearch for indexing the logs, Kibana for searching them but now uses Fluentd to obtain the logs. What Fluentd does that is different is that the indexable component now has keys based on OpenShift values - which node the application is running on, the Pod name, the Cluster name. This means you can now search and see which exact Pod is throwing the error.</p>
</div>
<div class="paragraph">
<p>For example, if you had three Pods running 'myapp' you could search for any errors in named Pods, any informational messages from Pods on a given node and the like.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_examining_logs_using_the_ocp_ui">Examining Logs using the OCP UI</h4>
<div class="paragraph">
<p>Switch to the Developer view and then to the topology view. You should have one copy of the Application running (one Pod).
On the Pod icon click the URL icon (top right). This will open another tab with the output of the Application in it.
Switch back to the OpenShift interface and click on the Pod to show the DC tab on the right side of the page.</p>
</div>
<div class="paragraph">
<p>Now click on Resources if it doesn&#8217;t display that to list the Pods, then click on 'View Logs', situated to the right of the single Pod in the DC tab.
This will present you with the Pod Details page and the log output for this Pod.</p>
</div>
<div class="paragraph">
<p>Switch back to the Application browser tab that opened when clicking the URL icon.
Add /log to the end of the URL and hit return. The page should change to a simple webpage that says 'Logged 20 messages&#8230;&#8203;.'</p>
</div>
<div class="paragraph">
<p>Switch back to the OpenShift interface. The log will now have twenty log messages (count 0 to count 19) displayed.</p>
</div>
<div class="paragraph">
<p>Click on Topology. Click on the Pod to bring up the DC tab and select the Details tab.</p>
</div>
<div class="paragraph">
<p>We are going to scale the Application to two copies; click on the up arrow displayed next to the Pod indicator <strong>once</strong>. Click on Resources tab and make sure there are now two copies of the Application running.</p>
</div>
</div>
<div class="sect3">
<h4 id="_examining_logs_using_the_oc_command">Examining logs using the oc command</h4>
<div class="paragraph">
<p>Switch to the Terminal tab. In the terminal tab type the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get pods | grep Running</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will list two Pods running - these are your applications. They will have a name such as nodeatomic-1-xxxxx.</p>
</div>
<div class="paragraph">
<p>For each of the Pods type (replace the xxxxx for the five characters at the end of the Pod name):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc logs nodeatomic-1-xxxxx</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you repeat the command for both one of them will have the simple log, the other will have the output of the twenty messages.</p>
</div>
<div class="paragraph">
<p>Return to the Application tab and change the end of the url from /log to /log?message=TEST</p>
</div>
<div class="paragraph">
<p>Switch back to the Terminal tab and repeat the 'oc logs' command for both Pods again.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
One of the Pods will now have the message TEST shown. In all probabilities it will be the same one that displayed the twenty log messages - this is because the session in the browser 'sticky' connects to one Pod.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_openshift_enterprise_logging">OpenShift Enterprise Logging</h4>
<div class="paragraph">
<p>The Cluster you are using for this lab is not enabled for Enterprise logging. If it was developer, depending on RBAC, can make ElasticSearch related searches over aggregated logs for applications.</p>
</div>
</div>
<div class="sect3">
<h4 id="_cleaning_up_the_lab">Cleaning up the lab</h4>
<div class="paragraph">
<p>Finally, go back to the OpenShift UI. Click on Administrator/Projects. Click on the three dot menu to the far right of your events-{{USER_ID}} project. Select Delete Project. When prompted type the name of your project.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-04-06 19:08:41 UTC
</div>
</div>
</body>
</html>