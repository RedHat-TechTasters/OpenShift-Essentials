<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<title>Introduction</title>
<link rel="stylesheet" href="./lab-style.css">
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="paragraph">
<p>Author: Ian Lawson (feedback to <a href="mailto:ian.lawson@redhat.com">ian.lawson@redhat.com</a>)</p>
</div>
<div class="sect2">
<h3 id="_introduction">Introduction</h3>
<div class="paragraph">
<p>This lab will introduce the attendee to concepts of deployments and configuration injection using OpenShift Container Platform.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The attendee will be using a browser for interacting with both the OpenShift Container Platform UI and the provided terminal (for command line exercises). It is suggested the attendee uses Chrome or Firefox.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
This lab follows directly on from the Application Basics one so it is assumed the attendee is logged on to the system and has the applications pre-created. If you are starting at this lab please repeat the commands from the Application Basics lab. You should start this lab with two applications running in the project 'sandbox-{{USER_ID}}', nodenews and ocpnode.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_introducing_deployment_configurations">Introducing Deployment Configurations</h3>
<div class="paragraph">
<p>Ensure you are on the Administrator View (top level, select 'Administrator')</p>
</div>
<div class="paragraph">
<p>Select Home/Projects and click on the sandbox-{{USER_ID}} project</p>
</div>
<div class="paragraph">
<p>Select (from the left hand menu) 'Workloads/Deployment Configs'</p>
</div>
<div class="imageblock">
<div class="content">
<img src="deployment-1.png" alt="Deployment Configs">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Observe the information provided on the Deployment Configs screen. DC indicates the Deployment Config by name, NS is the project/namespace, Labels are the OpenShift labels applied to the DC for collating and visualisation, status indicates the active Pod count for the Deployment and pod selector indicates the labels used for the Pods attributed to the Deployment Config.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click on the 'nodenews' deployment-config</p>
</div>
<div class="paragraph">
<p>Next to the Pod icon, with the count in it which should be set to two, click on the up arrow twice</p>
</div>
<div class="imageblock">
<div class="content">
<img src="deployment-2.png" alt="Scaling the Deployment">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
We have told the deployment config to run four replicas. The system now updated the replication controller, whose job is to make sure that x replicas are running healthily, and once the replication controller is updated the system will ensure that number of replicas is running
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click on ‘YAML’</p>
</div>
<div class="paragraph">
<p>In the YAML find an entry for replicas. It should say 4. Set it to 2, then save.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="deployment-3.png" alt="Editing the DC YAML">
</div>
</div>
<div class="paragraph">
<p>Click on ‘Deployment Configs’ near the top of the panel.</p>
</div>
<div class="paragraph">
<p>Select the nodenews deployment config by clicking on the nodenews DC link</p>
</div>
<div class="paragraph">
<p>Ensure the Pod count is now two - we have scaled the deployment of the Application up from 2 to 4 using the UI controls, then down to 2 using the direct editing of the YAML for the object. This is one of the key strengths of the OpenShift UI, the ability to directly edit the YAML of any object owned by the user</p>
</div>
</div>
<div class="sect2">
<h3 id="_dependency_injection_using_config_maps">Dependency Injection using Config Maps</h3>
<div class="paragraph">
<p>Click on 'Workloads/Config Maps'</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Config Maps allow you to create groups of name/value pairs in objects that can be expressed into the Applications via the Deployment Configs and can change the file system, environment and behaviour of the Application without having to change the 'image' from whence the Application was created. This is extremely useful for dependency injection without having to rebuild the Application image
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click on ‘Create Config Map’</p>
</div>
<div class="paragraph">
<p>In the editor change the name: from example to ‘nodenewsconfig’</p>
</div>
<div class="paragraph">
<p>Delete all of the lines below <strong>data:</strong></p>
</div>
<div class="paragraph">
<p>Add “  env1: test”</p>
</div>
<div class="paragraph">
<p>Add “  env2: test”</p>
</div>
<div class="paragraph">
<p>Make sure there is a space between the ':' and the data itself, otherwise it is invalid YAML and the editor will not allow you to save it.</p>
</div>
<div class="paragraph">
<p>The YAML should look similar to the screenshot below, with your project name rather than sandbox-user99</p>
</div>
<div class="imageblock">
<div class="content">
<img src="deployment-4.png" alt="Example Config Map YAML">
</div>
</div>
<div class="paragraph">
<p>Press 'Create'</p>
</div>
<div class="paragraph">
<p>Go back to the terminal tab and type the following</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get configmaps
oc describe configmap nodenewsconfig</code></pre>
</div>
</div>
<div class="paragraph">
<p>Go back to UI, select 'Workloads/Deployment Configs'</p>
</div>
<div class="paragraph">
<p>Click on the 'nodenews' dc</p>
</div>
<div class="paragraph">
<p>Click on 'Environment'</p>
</div>
<div class="paragraph">
<p>In ‘All Values from existing config maps or secrets (envFrom)’ select nodenewsconfig from the pulldown on the left</p>
</div>
<div class="paragraph">
<p>Add nodenewsconfig as the prefix in the righthand textbox (labelled PREFIX (OPTIONAL) )</p>
</div>
<div class="paragraph">
<p>Click 'Save'</p>
</div>
<div class="paragraph">
<p>Click on 'Workloads/Pods' - if you are quick enough you will see the nodenews Pods being redeployed</p>
</div>
<div class="paragraph">
<p><strong>By default when you create a Deployment Config in OpenShift, as part of an Application or as a standalone object via YAML, the Deployment Config will have two distinct triggers for automation. These make the Deployment redeploy when a: the image that the Deployment Config is based on changes in the registry or b: the defined configuration of the Deployment changes via a change to the DC object itself</strong></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
These are default behaviours but can be overridden. They are designed to make sure that the current deployment exactly matches the Images and the definition of the deployment by default.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the filter pulldown at the top select the checkbox for 'Running'</p>
</div>
<div class="paragraph">
<p>Click on one of the Running Pods for 'nodenews'</p>
</div>
<div class="paragraph">
<p>In the Pod Details page click on 'Terminal'</p>
</div>
<div class="paragraph">
<p>In the terminal type ‘env | grep nodenewsconfig’</p>
</div>
<div class="paragraph">
<p><strong>Note that the env variables from the config map have been expressed within the Pod as env variables (with the nodenewsconfig prefixed)</strong></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
What has happened is that the environment variables have been transcribed into the container; the redeployment that happened automatically, because the
deployment is set to auto-redeploy when either the image that the container is sourced from is updated, or the configuration of the deployment changes, which it did
when we injected the config map as environment variables.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="deployment-5.png" alt="Injected config map environment variables">
</div>
</div>
<div class="paragraph">
<p>Go back to the Terminal tab you created in the pre-requisites. We are going to use some material pre-loaded into the terminal image. Type the following commands in the Terminal tab.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace/workshop4/attendee
cat testfile.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>This file is the one to be used. If it, or any of the directories, don&#8217;t exist, please follow the pre-requisite instructions and recreate the Terminal application.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
All objects in Kubernetes/Openshift can be expressed as yaml and this is a basic configmap for a file. What is very nice about the API and it&#8217;s object oriented nature is that you can export any object that you have the RBAC rights to view and import them directly back into OpenShift, which is what we will do now with the following commands in the terminal
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f testfile.yaml
oc get configmaps</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="deployment-6.png" alt="terminal output">
</div>
</div>
<div class="paragraph">
<p>Go back to the UI, select 'Workloads/Deployment Configs'</p>
</div>
<div class="paragraph">
<p>Select 'nodenews' dc</p>
</div>
<div class="paragraph">
<p>Click on 'YAML'</p>
</div>
<div class="paragraph">
<p>In order to add the config-map as a volume we need to change the container specification within the deployment config.</p>
</div>
<div class="paragraph">
<p>Find the setting for ‘imagePullPolicy’. Put the cursor to the end of the line. Hit return. Underneath enter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>        volumeMounts:
          - name: workshop-testfile
            mountPath: /workshop/config</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="deployment-7.png" alt="code insert">
</div>
</div>
<div class="paragraph">
<p>Make sure the indentation is the same as for the ‘imagePullPolicy’.</p>
</div>
<div class="paragraph">
<p>Now in the ‘spec:’ portion we need to add our config-map as a volume.</p>
</div>
<div class="paragraph">
<p>Find ‘restartPolicy’. Put the cursor to the end of the line and press return. Underneath enter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>     volumes:
       - name: workshop-testfile
         configMap:
           name: testfile
           defaultMode: 420</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="deployment-8.png" alt="second code insert">
</div>
</div>
<div class="paragraph">
<p>Save the deployment config.</p>
</div>
<div class="paragraph">
<p>Click on 'Workloads/Pods'. Watch the new versions of the nodenews application deploy.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
On the Pods panel you can set the filter for 'Name:' to be nodenews, and set a filter of 'Running' which will display only the Running Pods for nodenews
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="deployment-8a.png" alt="filtered pod list">
</div>
</div>
<div class="paragraph">
<p>When they finish deploying click on one of the nodenews Pods. Click on 'Terminal'.</p>
</div>
<div class="paragraph">
<p>In the terminal type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workshop
ls
cd config</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Note that we have a new file called ‘app.conf’ in this directory. This file is NOT part of the image that generated the container.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the terminal type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cat app.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>This is the value from the configmap object expressed as a file into the running container.</strong></p>
</div>
<div class="paragraph">
<p>In the terminal type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>vi app.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Press ‘i’ to insert, then type anything. Then press ESC. Then type ‘:wq’</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
You will not be able to save it. The file expressed into the Container from the configmap is ALWAYS readonly which ensures
any information provided via the config map is controlled and immutable.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Type ‘:q!’ to quit out of the editor</p>
</div>
</div>
<div class="sect2">
<h3 id="_dependency_injection_of_sensitive_information_using_secrets">Dependency Injection of sensitive information using Secrets</h3>
<div class="paragraph">
<p><strong>The config map to be written as a file is actually written to the Container Hosts as a file, and then expressed into the running Container as a symbolic link. This is good but can be seen as somewhat insecure because the file is stored 'as-is' on the Container Hosts, where the Containers are executed</strong></p>
</div>
<div class="paragraph">
<p><strong>For secure information, such as passwords, connection strings and the like, OpenShift has the concept of 'Secrets'. These act like config maps 'but' importantly the contents of the secrets are encrypted at creation, encrypted at storage when written to the Container Hosts and then unencrypted only when expressed into the Container, meaning only the running Container can see the value of the secret.</strong></p>
</div>
<div class="paragraph">
<p>In the UI select 'Workloads/Secrets'</p>
</div>
<div class="paragraph">
<p>Click on 'Create'</p>
</div>
<div class="paragraph">
<p>Choose ‘Key/Value Secret'</p>
</div>
<div class="paragraph">
<p>For ‘Secret Name’ give ‘nodenewssecret’</p>
</div>
<div class="paragraph">
<p>Set ‘Key’ to ‘password’</p>
</div>
<div class="paragraph">
<p>Set ‘Value’ textbox to ‘mypassword’</p>
</div>
<div class="paragraph">
<p>Click ‘Create’</p>
</div>
<div class="paragraph">
<p>When created click on the ‘YAML’ box in the Secrets/Secret Details overview</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Note that the type is ‘Opaque’ and the data is encrypted
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click on ‘Add Secret To Workload’</p>
</div>
<div class="paragraph">
<p>In the ‘Select a workload’ pulldown select the nodenews DC</p>
</div>
<div class="paragraph">
<p>Ensure the ‘Add Secret As’ is set to Environment Variables</p>
</div>
<div class="paragraph">
<p>Add the Prefix ‘secret’</p>
</div>
<div class="paragraph">
<p>Click ‘Save’</p>
</div>
<div class="paragraph">
<p>Watch the Pods update on the subsequent ‘DC Nodenews’ overview</p>
</div>
<div class="paragraph">
<p>When they have completed click on ‘Pods’ in the DC panel (not the menu on the left)</p>
</div>
<div class="paragraph">
<p>Choose one of the nodenews running pods, click on it, choose Terminal</p>
</div>
<div class="paragraph">
<p>In the terminal type ‘env | grep secret’</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
What we have done is express an encrypted value into a running Container where it is unencrypted and expressed as an environment variable, which can be consumed by the application
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_understanding_the_deployment_strategies">Understanding the Deployment Strategies</h3>
<div class="paragraph">
<p>Click on 'Workloads/Deployment Configs'</p>
</div>
<div class="paragraph">
<p>Click on the DC for 'nodenews'</p>
</div>
<div class="paragraph">
<p>Scale the Application up to four copies using the up arrow next to the Pod count indicator</p>
</div>
<div class="paragraph">
<p>Once the count has gone to 4 and all the Pods are indicated as healthy (the colour of the Pod ring is blue for all Pods) select Action/Start Rollout.</p>
</div>
<div class="paragraph">
<p>The DC panel will now render the results of the deployment.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Deployments can have one of two strategies. This example uses the 'Rolling' strategy which is designed for zero downtime deployments. It works but spinning up a single copy of the new Pod, and when that Pod reports as being healthy only then is one of the old Pods removed. This ensures that at all times the required number of replicas are running healthy with no downtime for the Application itself.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click on 'Actions/Edit Deployment Config'</p>
</div>
<div class="paragraph">
<p>Scroll the editor down to the ‘spec:’ tag as shown below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="deployment-9.png" alt="rolling deployment">
</div>
</div>
<div class="paragraph">
<p>Change the type: tag of the strategy to Recreate as shown below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="deployment-10.png" alt="recreate deployment">
</div>
</div>
<div class="paragraph">
<p>Click on 'Save'</p>
</div>
<div class="paragraph">
<p>Click on 'Workloads/Deployment Configs', select nodenews dc</p>
</div>
<div class="paragraph">
<p>Click on ‘Action/Start Rollout’</p>
</div>
<div class="paragraph">
<p>Watch the colour of the Pod rings as the system carries out the deployment</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
In the case of a Recreate strategy the system ensures that NO copies of the old deployment are running simultaneously with the new ones. It deletes all the running Pods, regardless of the required number of replicas, and when all Pods report as being fully deleted it will start spinning up the new copies. This is for a scenario when you must NOT have any users interacting with the old Application once the new one is deployed, such as a security flaw in the old Application
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_cleaning_up">Cleaning up</h4>
<div class="paragraph">
<p>Select Home/Projects</p>
</div>
<div class="paragraph">
<p>In the triple dot menu next to your own project (sandbox-{{USER_ID}}) select ‘Delete Project’
Type ‘sandbox-{{USER_ID}}’ such that the Delete button turns red and is active.</p>
</div>
<div class="paragraph">
<p>Press Delete to remove the project.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-04-06 19:15:01 UTC
</div>
</div>
</body>
</html>