<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<title>Introduction</title>
<link rel="stylesheet" href="./lab-style.css">
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="paragraph">
<p>Author: Mark Roberts (feedback to <a href="mailto:mroberts@redhat.com">mroberts@redhat.com</a>)</p>
</div>
<div class="sect2">
<h3 id="_introduction">Introduction</h3>
<div class="paragraph">
<p>Liveness and Readiness probes are Kubernetes capabilities that enable teams to make their containerized applications more reliable and robust. However, if used inappropriately they can result in none of the intended benefits, and can actually make a microservice based application unstable.</p>
</div>
<div class="paragraph">
<p>The purpose of each probe is quite simple and is described well in the OpenShift documentation. The use of each probe is best understood by examining the action that will take place if the probe is activated.</p>
</div>
<div class="paragraph">
<p><strong>Liveness</strong> : Under what circumstances is it appropriate to restart the pod?</p>
</div>
<div class="paragraph">
<p><strong>Readiness</strong> : under what circumstances should we take the pod out of the list of service endpoints so that it no longer responds to requests?</p>
</div>
<div class="paragraph">
<p><strong>Startup</strong> : Validates that the application within a container has started successfully.</p>
</div>
<div class="paragraph">
<p>Coupled with the action of the probe is the type of test that can be performed within the pod :</p>
</div>
<div class="paragraph">
<p><strong>Http GET request</strong> : For success, a request to a specific http endpoint must result in a response between 200 and 399.</p>
</div>
<div class="paragraph">
<p><strong>Execute a command</strong> : For success, the execution of a command within the container must result in a return code of 0.</p>
</div>
<div class="paragraph">
<p><strong>TCP socket check</strong> : For success, a specific TCP socket must be successfully opened on the container.</p>
</div>
</div>
<div class="sect2">
<h3 id="_creating_the_project_and_application">Creating the project and application</h3>
<div class="paragraph">
<p>Log on to cluster as userx, password openshift</p>
</div>
<div class="paragraph">
<p>Ensure you are on the Administrator View (top level, select Administrator)</p>
</div>
<div class="paragraph">
<p>The Administrator view provides you with an extended functionality interface that allows you to deep dive into the objects available to your user. The Developer view is an opinionated interface designed to ease the use of the system for developers. This workshop will have you swapping between the contexts for different tasks.</p>
</div>
<div class="paragraph">
<p>Click on 'Create Project'</p>
</div>
<div class="paragraph">
<p>Name - ‘probes-{{USER_ID}}’</p>
</div>
<div class="paragraph">
<p>Display Name - 'Probes'</p>
</div>
<div class="paragraph">
<p>Description - 'Liveness and readiness probes'</p>
</div>
<div class="paragraph">
<p>as shown in the image below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="healthprobes-1.png" alt="Project creation">
</div>
</div>
<div class="paragraph">
<p>In the top left of the UI, where the label indicates the view mode, change the mode from Administrator to Developer and select the Topology view.</p>
</div>
<div class="paragraph">
<p>Select ‘From Catalog’</p>
</div>
<div class="paragraph">
<p>Clear any checkboxes in the section labelled 'Type' so that all options are available.</p>
</div>
<div class="paragraph">
<p>Enter ‘node’ in the search box</p>
</div>
<div class="paragraph">
<p>The various catalogue items present different configurations of applications that can be created. For example the node selections include a simple node.js application or node.js with a database platform that is pre-integrated and ready to use within the application. For this workshop you will use a simple node.js application.</p>
</div>
<div class="paragraph">
<p>Select ‘Node.js’</p>
</div>
<div class="paragraph">
<p>Click on ‘Create Application’</p>
</div>
<div class="paragraph">
<p>Select the default offering for the Builder Image Version</p>
</div>
<div class="paragraph">
<p>For the GIT repository use : <a href="https://github.com/marrober/simpleRest.git" target="_blank" rel="noopener">https://github.com/marrober/simpleRest.git</a></p>
</div>
<div class="paragraph">
<p>In a separate browser tab go to <a href="https://github.com/marrober/simpleRest.git" target="_blank" rel="noopener">https://github.com/marrober/simpleRest.git</a></p>
</div>
<div class="paragraph">
<p>You can see that the GIT repository at this location only has a small number of files specific to the application. There is no content specific to how the application should be built or deployed into a container since that will be covered by the OpenShift source-2-image process.</p>
</div>
<div class="paragraph">
<p>Close the github tab</p>
</div>
<div class="paragraph">
<p>Back at the OCP4 user interface complete the following information in the section titled 'General'.</p>
</div>
<div class="paragraph">
<p>For the Application name enter 'rest-application'.</p>
</div>
<div class="paragraph">
<p>For the Name field enter 'node-app-rest'</p>
</div>
<div class="paragraph">
<p>The application name field is used to group together multiple items under a single grouping within the topology view. The name field is used to identify the specific containerised application.</p>
</div>
<div class="paragraph">
<p>In the Resources section ensure that you select 'Deployment Config'</p>
</div>
<div class="paragraph">
<p>In the Advanced Options section ensure the ‘Create a route to the application’ checkbox is checked.</p>
</div>
<div class="paragraph">
<p>Click Create</p>
</div>
<div class="paragraph">
<p>The user interface will then change to display the Topology view. This is a pictorial representation of the various items (applications, databases etc.) that have been created from the catalogue and added to an application grouping.</p>
</div>
<div class="paragraph">
<p>Multiple application groupings can exist within a single project.</p>
</div>
</div>
<div class="sect2">
<h3 id="_viewing_the_running_application">Viewing the running application</h3>
<div class="paragraph">
<p>Click on the Icon marked ‘Node’</p>
</div>
<div class="paragraph">
<p>A side panel will appear o the right hand side with information on the Deployment Configuration that has just been created. The details tab shows summary information and allows the user to scale the number of pods up and down. The resources tab shows information on the build process, the pods and the services and route to reach the application (if these have been created). The monitoring tab shows information on warnings, metrics and events.</p>
</div>
<div class="paragraph">
<p>You will also see specific information about Health Checks which can be created using the graphical user interface by clicking on the 'Add Health Checks' hyperlink. If you have an application for which you do not require Health Checks then you can click on the grey cross to dismiss the information panel shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="healthprobes-1a.png" alt="Health Checks prompt">
</div>
</div>
<div class="paragraph">
<p>Wait for the Build to finish, the Pod to change from Container Creating to Running.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Pod Colour Scheme</div>
<div class="paragraph">
<p>The colour scheme of the pods is important and conveys information about the pod health and status. The following colours are used :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Running - Dark blue</p>
</li>
<li>
<p>Not Ready - Mid blue</p>
</li>
<li>
<p>Warning - Orange</p>
</li>
<li>
<p>Failed - Red</p>
</li>
<li>
<p>Pending - light blue</p>
</li>
<li>
<p>Succeeded - Green</p>
</li>
<li>
<p>Terminating - Black</p>
</li>
<li>
<p>Unknown - Purple</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>The above graphical mechanism for creating probes will be explained shortly. Since many applications required probes to be created as part of a deployment process it is sensible to start with how to create probes using the command line.</p>
</div>
<div class="paragraph">
<p>When the build has completed the right hand side panel will shown something similar to the image below. Note that the route will be different to that which is shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="healthprobes-2.png" alt="Deployment configuration resource information">
</div>
</div>
<div class="paragraph">
<p>Click on the arrow on the top right corner of the Pod, or click on the route URL shown in the right hand side resource details window. The application window will launch in a new browser window and should display text as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Hello - this is a simple REST interface v1.0</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_liveness_probe">Liveness Probe</h3>
<div class="paragraph">
<p>A number of probes will be created to show the different behaviours. The first probe will be a liveness probe that will result in the restart of the pod.</p>
</div>
<div class="paragraph">
<p>Since this work will be done using the oc command line you need to select the new project using the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc project probes-{{USER_ID}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create the probe use the OC command line interface to execute the following command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc set probe dc/node-app-rest --liveness --initial-delay-seconds=30 --failure-threshold=1 --period-seconds=10 --get-url=http://:8080/health</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above probe will create a new liveness probe with the characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Become active after 30 seconds</p>
</li>
<li>
<p>Initiated a reboot after 1 instance of a failure to respond</p>
</li>
<li>
<p>Probe the application every 10 seconds <em>Note that ordinarily a gap of 10 seconds between probes would be considered very long, but we use this time delay within the workshop to allow time for observing the behaviour of the probe.</em></p>
</li>
<li>
<p>Use the URL /health on the application at port 8080. Note that there is no need to specify a URL for the application.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The command line response should be as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>deploymentconfig.apps.openshift.io/node-app-rest probes updated</code></pre>
</div>
</div>
<div class="paragraph">
<p>Review the liveness probe information by executing the command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc describe dc/node-app-rest</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of this command will include the following section that highlights the new liveness probe</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Pod Template:
  Labels:	app=node-app-rest
		    deploymentconfig=node-app-rest
  Containers:
   node-app-rest:
    Image:		image-registry.openshift-image-registry.svc:5000/probes2/node-app-rest@sha256:bf377...241
    Port:		    8080/TCP
    Host Port:		0/TCP
    Liveness:		http-get http://:8080/health delay=30s timeout=1s period=10s #success=1 #failure=1
    Environment:	&lt;none&gt;
    Mounts:		    &lt;none&gt;
  Volumes:		    &lt;none&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively to view the probe in a different format use the command below :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get dc/node-app-rest -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Part of the output will show:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>livenessProbe:
    failureThreshold: 1
    httpGet:
        path: /health
        port: 8080
        scheme: HTTP
    initialDelaySeconds: 30
    periodSeconds: 10
    successThreshold: 1
    timeoutSeconds: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>To view the above information graphically then use the following steps:</p>
</div>
<div class="paragraph">
<p>Select the Topology view of the application.</p>
</div>
<div class="paragraph">
<p>Click on the pod in the centre of the screen to display the information panel on the right hand side.
From the action menu on the right hand side click <strong>Edit Deployment Configuration</strong> as shown in the image below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="healthprobes-3.png" alt="View of the health probe in the Deployment Configuration">
</div>
</div>
<div class="paragraph">
<p>On the Deployment Configuration page that is displayed ensure that the YAML tab is selected and scroll down to around line 200 to see the YAML definition for the liveness probe. It is also possible to edit the parameters of the probe from this screen if necessary.</p>
</div>
<div class="paragraph">
<p>Also from the action menu it is possible to display the health information in a dedicated user interface that is much easier to find than looking in the deployment configuration. From the action menu select "Edit Health Checks" to get to a screen as shown below :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="healthprobes-3a.png" alt="View of the health probe">
</div>
</div>
<div class="paragraph">
<p>Click on the green link with the text "Liveness Probe Added" to view the specific characteristics of the liveness probe.</p>
</div>
<div class="paragraph">
<p>In order to execute the probe it is necessary to simulate a pod failure that will stop the application from responding to the health check. A specific REST interface on the application has been created for this purpose called /ignore.</p>
</div>
<div class="sect3">
<h4 id="_activation_of_the_liveness_prove">Activation of the Liveness Prove</h4>
<div class="paragraph">
<p><strong>To view the activity of the probe it is necessary to open two windows.</strong></p>
</div>
<div class="paragraph">
<p>Select the Topology view of the application.</p>
</div>
<div class="paragraph">
<p>Click on the arrow on the top right hand corner of the node icon to open the application URL in a new browser tab.</p>
</div>
<div class="paragraph">
<p>Back on the OpenShift browser tab, Click on the pod to open the details window on the right hand side and then click on the pod link on the resources tab. This will display a multi-tab window with details of the pod, select the events tab.</p>
</div>
<div class="paragraph">
<p>Switch to the application tab and put /ip on the end of the url and hit return. This will display the ip address of the pod.</p>
</div>
<div class="paragraph">
<p>Change the url to have /health on the end and hit return. This will display the amount of time that the pod has been running.</p>
</div>
<div class="paragraph">
<p>Change the url to have /ignore on the end and hit return. Quickly move to the browser tab showing the pod events and watch for the probe event.</p>
</div>
<div class="paragraph">
<p>The pod will restart after 1 failed probe event which takes up to 10 seconds depending on where the schedule is between the probe cycles. The events for the pod on the details screen will be similar to that shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="healthprobes-4.png" alt="Pod events showing activation of the liveness probe">
</div>
</div>
<div class="paragraph">
<p>The events after the firing of the liveness probe are the re-pulling and starting of the container image in a new pod.</p>
</div>
<div class="paragraph">
<p>Switch to the application tab and put /health on the end of the url and hit return. This will display the amount of time that the new pod has been running, which will understandably be a small number.</p>
</div>
<div class="paragraph">
<p>In order to experiment with the readiness probe it is necessary to switch off the liveness probe. This can either be done by changing the deployment configuration YAML definition using the web interface or by executing the following command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc set probe dc/node-app-rest --liveness --remove</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_readiness_probe">Readiness Probe</h3>
<div class="paragraph">
<p>To create the readiness probe use the web user interface. From the topology view right click on the node for the application and from the pop up menu select "Add Health Check".</p>
</div>
<div class="paragraph">
<p>On the health checks page select to add a readiness probe usng the following parameters.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Inital Delay - Become active after 30 seconds</p>
</li>
<li>
<p>Failure Threshold - Remove the pod from the service endpoint after 3 instances of a failure to respond</p>
</li>
<li>
<p>Success Threshold - Cancel the removal of the pod and add it back to the service endpoint after 1 successful response</p>
</li>
<li>
<p>Period - Probe the application every 5 seconds</p>
</li>
<li>
<p>Path - Use the URL /health on the application at port 8080. Note that there is no need to specify a URL for the application.</p>
</li>
<li>
<p>Port - 8080</p>
</li>
<li>
<p>Timeout - 1 second</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Click the grey tick at the bottom of the parameter box to save the readiness probe and then click the blue 'Add' button to commit the probe.</p>
</div>
<div class="paragraph">
<p>Review the probe created using the above steps :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc describe dc/node-app-rest</code></pre>
</div>
</div>
<div class="paragraph">
<p>and</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get dc/node-app-rest -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>View the state of the pod within the endpoints using the command below :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get ep/node-app-rest -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of the above command will list the details of the service endpoint which will include information on the pod to which the health probe is attached as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>apiVersion: v1
kind: Endpoints
metadata:
  annotations:
    endpoints.kubernetes.io/last-change-trigger-time: 2019-11-26T16:04:50Z
  creationTimestamp: 2019-11-26T09:37:12Z
  labels:
    app: node-app-rest
    app.kubernetes.io/component: node-app-rest
    app.kubernetes.io/instance: node-app-rest
    app.kubernetes.io/name: nodejs
    app.kubernetes.io/part-of: master-rest
    app.openshift.io/runtime: nodejs
    app.openshift.io/runtime-version: "10"
  name: node-app-rest
  namespace: probes1
  resourceVersion: "1172051"
  selfLink: /api/v1/namespaces/probes1/endpoints/node-app-rest
  uid: 534139aa-1030-11ea-af1c-024039909e8a
subsets:
- addresses:
  - ip: 10.128.2.145
    nodeName: ip-10-0-136-74.eu-central-1.compute.internal
    targetRef:
      kind: Pod
      name: node-app-rest-5-hwj89
      namespace: probes1
      resourceVersion: "1172049"
      uid: ad6cc0e5-1043-11ea-af1c-024039909e8a
  ports:
  - name: 8080-tcp
    port: 8080
    protocol: TCP</code></pre>
</div>
</div>
<div class="paragraph">
<p>The lines of interest above are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>subsets:
- addresses:
  - ip: 10.128.2.145</code></pre>
</div>
</div>
<div class="paragraph">
<p>This shows that the address is currently part of the endpoint (it will participate in servicing requests) prior to the readiness probe activation.</p>
</div>
<div class="sect3">
<h4 id="_activation_of_the_readiness_probe">Activation of the Readiness Probe</h4>
<div class="paragraph">
<p>Select the Topology view of the application.</p>
</div>
<div class="paragraph">
<p>Click on the arrow on the top right hand corner of the node icon to open the application URL in a new browser tab (unless you already have one open).</p>
</div>
<div class="paragraph">
<p>On the OpenShift browser tab, click on the pod to open the details window on the right hand side and then click on the pod link on the resources tab. This will display a multi-tab window with details of the pod, select the events tab.</p>
</div>
<div class="paragraph">
<p>Switch to the application tab and put /ip on the end of the url and hit return. This will display the ip address of the pod.</p>
</div>
<div class="paragraph">
<p>Change the url to have /health on the end and hit return. This will display the amount of time that the pod has been running.</p>
</div>
<div class="paragraph">
<p>Change the url to have /ignore on the end and hit return. Quickly move to the browser tab showing the pod events and watch for the probe event.</p>
</div>
<div class="paragraph">
<p>The pod events will show a screen similar to that which is shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="healthprobes-5.png" alt="Pod events showing activation of the readiness probe">
</div>
</div>
<div class="paragraph">
<p>Note that you will see the count of the readiness 'events' incrementing every 5 seconds.</p>
</div>
<div class="paragraph">
<p>You will also see that the events continue counting up since readiness probes do not stop firing just because the pod has been removed from the endpoint list. It is important that they continue to probe since the conditions may change and it may be appropriate to add the pod back into the endpoint list.</p>
</div>
<div class="paragraph">
<p>View the state of the pod within the endpoints using the command below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get ep/node-app-rest -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of the above command will list the details of the service endpoint which will include information on the pod to which the health probe is attached as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>subsets:
- notReadyAddresses:
  - ip: 10.128.2.145</code></pre>
</div>
</div>
<div class="paragraph">
<p>The subset of the command output shown above indicates that the address is now listed as ‘not ready’ and is not currently part of the endpoint.</p>
</div>
<div class="paragraph">
<p>Under production use, conditions for the application may change and the pod may recover from the inability to respond to the readiness probe. If this happens then it will be added back to the endpoint list.</p>
</div>
<div class="paragraph">
<p>It is also possible to see the pod events from the fly-out right click menu. To view this select the topology view in the web browser interface and click on the deployment configuration. On the dialog on the right hand side select the monitoring tab and open the "All Events" tab as shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="healthprobes-6.png" alt="Pod events showing activation of the readiness probe">
</div>
</div>
<div class="paragraph">
<p>To simulate the recovery of the application the Node application has a REST endpoint at /restore. Since the pod is currently not receiving communications from outside the cluster the call to the restore endpoint is done from within the pod command window.</p>
</div>
<div class="paragraph">
<p>Switch to the OpenShift browser window that was showing the pod events.</p>
</div>
<div class="paragraph">
<p>Note that you will see a large number of pod readiness probe failures while you were reading the notes.</p>
</div>
<div class="paragraph">
<p>In the OpenShift Console choose Administrator View, then Workloads/Pods. Click on the Pod that is running and in the Pod information page click on the Terminal tab.</p>
</div>
<div class="paragraph">
<p>Within the Pod Terminal enter the command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>curl -k localhost:8080/restore</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see a response similar to that shown below (with a different IP address):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>"10.128.2.146 restore switch activated"sh-4.2$</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now go back to the command line terminal.</p>
</div>
<div class="paragraph">
<p>View the state of the pod within the endpoints using the command below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get ep/node-app-rest -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see that the line of interest, previously shown above, has changed back to that shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>subsets:
- addresses:
  - ip: &lt;ip address of the pod&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>On the OpenShift browser page switch back to the events tab and you should see that the readiness probe failure count is no longer increasing.</p>
</div>
<div class="paragraph">
<p>Finally, switch to the application browser page and change the URL to end in /health. You should see that the application has been running for some time (compared to the liveness probe that showed a restart had taken place) and it should be responding successfully to the health probe.</p>
</div>
</div>
<div class="sect3">
<h4 id="_cleaning_up">Cleaning up</h4>
<div class="paragraph">
<p>From the OpenShift browser window click on 'administrator' and then 'Projects' on the left hand side menu.</p>
</div>
<div class="paragraph">
<p>In the triple dot menu next to your own project (probes-{{USER_ID}}) select ‘Delete Project’
Type ‘probes-{{USER_ID}}’ such that the Delete button turns red and is active.</p>
</div>
<div class="paragraph">
<p>Press Delete to remove the project.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-04-06 19:10:56 UTC
</div>
</div>
</body>
</html>